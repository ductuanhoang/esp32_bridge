<html>

<head>
    <title>ESP32 XBee Config</title>
    <script src="jquery-3.7.0.min.js"></script>
    <script src="bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="bootstrap.min.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <style>
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            /* display: none; <- Crashes Chrome on hover */
            -webkit-appearance: none;
            margin: 0;
            /* <-- Apparently some margin are still there even though it's hidden */
        }

        input[type=number] {
            -moz-appearance: textfield;
            /* Firefox */
        }

        input[type=color] {
            -webkit-appearance: none;
            border: none;
            width: 20px;
            border-radius: 5px;
        }

        .card .card-body {
            transition: all ease-in-out 0.25s;
        }

        .card .card-body.disabled {
            opacity: 0.75;
            filter: blur(5px);
            pointer-events: none;
        }

        footer {
            padding: 20px 0;
        }

        .tooltip-inner {
            max-width: 95vw;
            width: 300px;
        }
    </style>
    <script>
        const releases_api_url = 'https://api.github.com/repos/nebkat/esp32-xbee/releases';
        const releases_html_url = 'https://github.com/nebkat/esp32-xbee/releases';

        $.fn.serializeObject = function () {
            var o = {};
            var a = this.serializeArray();
            $.each(a, function () {
                if (o[this.name]) {
                    if (!o[this.name].push) {
                        o[this.name] = [o[this.name]];
                    }
                    o[this.name].push(this.value || '');
                } else {
                    o[this.name] = this.value || '';
                }
            });
            return o;
        };

        $.fn.appendText = function (text) {
            $(this).append(document.createTextNode(text));
            return this;
        };

        function print_escape(str) {
            return str.replace(/\\/g, '\\\\')
                .replace(/\n/g, '\\n')
                .replace(/\r/g, '\\r')
                .replace(/\t/g, '\\t');
        }

        function print_unescape(str) {
            return str.replace(/\\\\/g, '\\')
                .replace(/\\n/g, '\n')
                .replace(/\\r/g, '\r')
                .replace(/\\t/g, '\t');
        }

        $(function () {
            $('[data-toggle="tooltip"]').tooltip({
                animation: false,
                container: 'body',
                html: true
            });

            var form = $("#form");

            form.on('submit', function (e) {
                e.preventDefault();
                e.stopPropagation();

                if (form[0].checkValidity() !== false) {
                    var submit = form.find(':submit').prop('disabled', true);
                    var data = JSON.stringify($(this).serializeObject());
                    $.post('config', data).done(function () {
                        $('#restarting-modal').modal('show');

                        // Allow some time to reload
                        setTimeout(function () {
                            reloadOnStatus = true;
                        }, 2500);
                    }).always(function () {
                        submit.prop('disabled', false);
                    });
                }

                form.addClass('was-validated');
            });

            form.find("input[type='checkbox']").each(function () {
                var self = $(this);
                var hidden = $("<input>")
                    .attr('name', self.attr('name'))
                    .attr('type', 'hidden')
                    .data('checkbox', true)
                    .attr('value', '0')
                    .prop('disabled', self.prop('checked'))
                    .insertAfter(self);
                $(this).on('change', function () {
                    hidden.prop('disabled', self.prop('checked'));
                });
            });

            var checkDisableIfs = function () {
                form.find("[data-disable-if]").each(function () {
                    var condition = $(this).data('disable-if-condition');
                    if (typeof condition === 'undefined') condition = ':not(:checked)';

                    var disabled = form.find($(this).data('disable-if')).filter(condition).length > 0;
                    var current = $(this).hasClass('disabled');
                    if (disabled === current) return;

                    $(this).prop('disabled', disabled);
                    $(this).toggleClass('disabled', disabled);

                    if ($(this).is('div')) {
                        $(this).find(':input').each(function () {
                            if (disabled) {
                                $(this).data('prop-disabled-previous', $(this).prop('disabled') === true)
                                    .data('class-disabled-previous', $(this).hasClass('disabled'))
                                    .prop('disabled', true)
                                    .addClass('disabled');
                            } else {
                                $(this).prop('disabled', $(this).data('prop-disabled-previous') === true)
                                    .toggleClass('disabled', $(this).data('class-disabled-previous') === true);
                            }
                        })
                    }
                });
            };

            checkDisableIfs();

            form.find(":input").on('change', checkDisableIfs);

            var tcpNetworksScanButton = form.find('.tcp-networks-scan');
            $('#switch-wire-wireless').on('change', (event), function () {
                // const protocolSelect = form.querySelector('.switch-wire-wireless');
                if (confirm("WARNING\n\nchange switch-wire-wireless")) {
                    tcpNetworksScanButton.prop('disabled', true);
                }
            });

            $('#switch-protocol').on('change', (event), function () {
                if (confirm("WARNING\n\nchange the Protocol")) {
                    // $(this).hide();
                    const value = event.target.value;
                    // checkDisableIfs();
                    console.log("hi");
                    const protocolSelect = form.querySelector('.switch-protocol');
                    const baudrateSelect = form.querySelector('.uart-baud-rate');
                    if (value === '1') {
                        baudrateSelect.value = '9600';
                    } else if (value === '2') {
                        baudrateSelect.value = '19200';
                    }
                }
            });

            const projectVersionText = $('#project-version');

            $.getJSON('config').done(function (data) {
                projectVersionText.text(data.version);

                if (data.version.includes('-')) data.version = data.version.substring(0, data.version.indexOf('-'));
                let current_version = parseFloat("0." + data.version.replace(/[^\d]/g, ""));
                $.getJSON(releases_api_url, function (data) {
                    if (!(data instanceof Array)) return;

                    let latest_version = 0;
                    let release_url = null;
                    let latest_version_prerelease = 0;
                    let prerelease_url = null;
                    for (const release of data) {
                        let version = parseFloat("0." + release.tag_name.replace(/[^\d]/g, ""));
                        if (release.prerelease && latest_version_prerelease === 0) {
                            latest_version_prerelease = version;
                            prerelease_url = release.html_url;
                            continue;
                        }
                        latest_version = version;
                        release_url = release.html_url;
                        break;
                    }

                    projectVersionText.attr('href', release_url)
                        .removeClass('text-muted');

                    if (latest_version === current_version) {
                        projectVersionText.addClass('text-success')
                            .appendText(' (latest)');
                    } else if (latest_version > current_version) {
                        projectVersionText.addClass('text-warning')
                            .appendText(" (old)");
                    } else if (latest_version < current_version) {
                        projectVersionText.attr('href', releases_html_url)
                            .addClass('text-primary')
                            .appendText(' (dev)');
                    }

                    if (latest_version_prerelease > Math.max(latest_version, current_version)) {
                        $('#prerelease-available').attr('href', prerelease_url).show();
                    }
                });

                form.find(':input').each(function () {
                    if (!this.name || typeof data[this.name] === 'undefined') return;

                    let value = data[this.name];
                    const $this = $(this);

                    if (Array.isArray(value)) {
                        const index = form.find(':input[name="' + this.name + '"]').index(this);

                        if (value.length > index) {
                            value = value[index];
                        } else {
                            return;
                        }
                    }

                    if (this.type === 'checkbox' || this.type === 'radio') {
                        var active = $this.val() == value;
                        $this.prop('checked', active);
                        $this.parent('.btn').toggleClass('active', active);
                    } else if (this.type === 'hidden' && $this.data('checkbox')) {
                        $this.prop('disabled', $this.val() != value);
                    } else {
                        $this.val(value);
                    }

                    // Reformat values when needed
                    if ($this.data('formatted')) $this.trigger('change');
                });

                checkDisableIfs();
            });

            var wifiRssiColorClass = function (rssi) {
                if (rssi > -50) {
                    return 'primary';
                } else if (rssi > -60) {
                    return 'success';
                } else if (rssi > -70) {
                    return 'warning';
                } else {
                    return 'danger';
                }
            };

            var deviceUptimeText = $('footer .uptime');
            var deviceHeapText = $('footer .heap');

            var wifiApStatusText = form.find('.wifi-ap-status');
            var wifiStaStatusText = form.find('.wifi-sta-status');

            var streamStatsTexts = form.find('.stream-stats');

            var reloadOnStatus = false;

            var secondsToHHMMSS = (seconds) => {
                var hours = Math.floor(seconds / 3600);
                var minutes = Math.floor(seconds / 60) % 60;
                seconds %= 60;

                return [hours, minutes, seconds]
                    .map(v => v < 10 ? "0" + v : v)
                    .join(":");
            };

            var humanDataSize = (bytes) => {
                var thresh = 1000;
                if (Math.abs(bytes) < thresh) {
                    return bytes + 'B';
                }
                var units = ['kB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
                var u = -1;
                do {
                    bytes /= thresh;
                    ++u;
                } while (Math.abs(bytes) >= thresh && u < units.length - 1);
                return bytes.toFixed(1) + units[u];
            };

            var statusUpdate = function () {
                $.ajax({
                    url: 'status',
                    dataType: 'json',
                    timeout: 2000
                }).done(function (data) {
                    if (reloadOnStatus) window.location.reload();

                    // Uptime
                    deviceUptimeText.text(secondsToHHMMSS(parseInt(data.uptime)));

                    // Heap
                    deviceHeapText.text(Math.round(data.heap.free / data.heap.total * 100) + "% free");

                    // Streams
                    streamStatsTexts.each(function () {
                        const stream = $(this).data('stream');
                        if (typeof data.streams[stream] === 'undefined') return;

                        const stats = data.streams[stream];

                        $(this).text(humanDataSize(stats.total.in) +
                            " in (" + humanDataSize(stats.rate.in) + "/s) / " +
                            humanDataSize(stats.total.out) +
                            " out (" + humanDataSize(stats.rate.out) + "/s)");
                        $(this).prop('title', stats.total.in.toLocaleString() +
                            " bytes in (" + (stats.rate.in * 8) + "bps) / " +
                            stats.total.out.toLocaleString() +
                            " bytes out (" + (stats.rate.out * 8) + "bps)");
                    });

                    // WiFi
                    let wifi = data.wifi;

                    wifiApStatusText.empty();
                    wifiStaStatusText.empty();

                    if (!wifi.ap.active) {
                        wifiApStatusText.text("Disabled");
                    } else {
                        wifiApStatusText.appendText(wifi.ap.ssid + (wifi.ap.authmode == 'OPEN' ? " (OPEN)" : ''))
                            .appendText(" / ")
                            .append($('<a>', { text: wifi.ap.ip4, href: 'http://' + wifi.ap.ip4 + '/' }))
                            .appendText(" / ")
                            .appendText(wifi.ap.devices + " device" + (wifi.ap.devices != 1 ? "s" : ''));
                    }

                    if (!wifi.sta.active) {
                        wifiStaStatusText.text("Not Active");
                    } else if (!wifi.sta.connected) {
                        wifiStaStatusText.text("Not Connected");
                    } else {
                        wifiStaStatusText.appendText(wifi.sta.ssid + (wifi.sta.authmode == 'OPEN' ? " (OPEN)" : ''))
                            .appendText(" / ")
                            .append($('<a>', { text: wifi.sta.ip4, href: 'http://' + wifi.sta.ip4 + '/' }))
                            .appendText(" / ")
                            .append($('<span>', { class: 'text-' + wifiRssiColorClass(wifi.sta.rssi), text: wifi.sta.rssi + "dBm" }));
                    }
                }).always(function () {
                    setTimeout(statusUpdate, 2500);
                });
            };
            statusUpdate();
            // update firmware status test-mode-button
            var statusUpdateFirmware = 0;
            var tcpUpdateFirmwareStatus = form.find('.from-update-firmware');
            tcpUpdateFirmwareStatus.on('click', function () {
                $.getJSON('firmware/update').always(function () {
                }).done(function (data) {
                    tcpUpdateFirmwareStatus.text("Updating firmware ...");
                });
            });
            // class="timer-counting-label"
            // class="timer-counting-value"
            var test_status_start = 0;
            var TestModeButtonSport = form.find('.test-mode-button');
            var timer_counting_label = form.find('.timer-counting-label');
            var timer_counting_value = form.find('.timer-counting-value');

            // TCP led player scan

            // WiFi Station networks list
            var wifiNetworksScanButton = form.find('.wifi-networks-scan');
            var wifiNetworksDropdownButton = form.find('.wifi-networks-dropdown');
            var wifiNetworksList = form.find('.wifi-networks');
            var wifiNetworksOpenList = wifiNetworksList.find('.wifi-networks-open');
            var wifiNetworksSecuredList = wifiNetworksList.find('.wifi-networks-secured');
            var wifiNetworksSsidInput = form.find('.wifi-networks-ssid');
            var wifiNetworksPasswordInput = form.find('.wifi-networks-pass');
            var wifiNetworksPasswordEmptyInput = form.find('.wifi-networks-pass-empty');

            wifiNetworksScanButton.on('click', function () {
                wifiNetworksOpenList.empty();
                wifiNetworksSecuredList.empty();

                wifiNetworksScanButton.prop('disabled', true);
                wifiNetworksDropdownButton.prop('disabled', true);
                $.getJSON('wifi/scan').always(function () {
                    wifiNetworksScanButton.prop('disabled', false);
                    wifiNetworksDropdownButton.prop('disabled', false);
                }).done(function (data) {
                    data.forEach(function (network) {
                        var entry = $('<a>', { class: 'wifi-network dropdown-item', href: 'javascript:void(0);' });
                        var open = network.authmode === "OPEN";
                        entry.data('ssid', network.ssid);
                        entry.data('rssi', network.rssi);
                        entry.data('authmode', network.authmode);
                        entry.data('open', open);

                        entry.appendText(network.ssid + (open ? '' : " (" + network.authmode + ") "))
                            .append($('<span>', { class: 'text-' + wifiRssiColorClass(network.rssi), text: network.rssi + "dBm" }));

                        entry.appendTo(open ? wifiNetworksOpenList : wifiNetworksSecuredList);
                    });

                    wifiNetworksList.find('.wifi-network').on('click', function () {
                        wifiNetworksSsidInput.val($(this).data('ssid'));
                        wifiNetworksPasswordInput.val('').prop('disabled', $(this).data('open'));
                        wifiNetworksPasswordEmptyInput.val('').prop('disabled', !$(this).data('open'));
                    });

                    wifiNetworksDropdownButton.trigger('click');
                });
            });

            wifiNetworksSsidInput.on('input change', function () {
                wifiNetworksPasswordInput.prop('disabled', false);
                wifiNetworksPasswordEmptyInput.prop('disabled', true);
            });

            // WiFi Station IP configuration
            var wifiStaSubnetInput = form.find('input[name="w_sta_subnet"]');

            // WiFi SoftAP IP configuration
            var wifiApGwInputs = form.find('input[name="w_ap_gw"]');
            var wifiApGwPrefixText = form.find('.wifi-ap-ip-prefix');
            var wifiApIpMinInput = form.find('input[name="w_ap_ip_min"]');
            var wifiApIpMaxInput = form.find('input[name="w_ap_ip_max"]');
            var wifiApSubnetInput = form.find('select[name="w_ap_subnet"]');

            wifiApSubnetInput.add(wifiApGwInputs).on('change input', function () {
                const parts = wifiApGwInputs.map((i, el) => Math.max(0, Math.min(255, el.value))).get();
                const subnet = parseInt(wifiApSubnetInput.children('option:selected').val());

                wifiApGwPrefixText.text(parts.slice(0, 3).join(".") + ".");

                const mask = 255 >> (subnet - 24);

                const d = parts[3];
                const min = (d & ~mask) + 1;
                const max = (d | mask) - 1;

                wifiApGwInputs.eq(3).prop('min', min).prop('max', max).toggleClass('is-invalid', d < min || d > max);

                wifiApIpMinInput.val(min);
                wifiApIpMaxInput.val(max);
            }).trigger('change');

            var socketClientConnectMessageInput = form.find('input[name="sck_cli_msg"]');
            var socketClientConnectMessageUnformattedInput = form.find('input[name="sck_cli_msg_unformatted"]');
            socketClientConnectMessageInput.on('change', function () {
                socketClientConnectMessageUnformattedInput.val(print_escape($(this).val()));
            });
            socketClientConnectMessageUnformattedInput.on('change', function () {
                socketClientConnectMessageInput.val(print_unescape($(this).val()));
            });
        });

        function autoTab(target) {
            var length = target.value.length;
            if (length >= target.maxLength) {
                target.value = target.value.slice(-1);
                var next = target;
                while (next = next.nextElementSibling) {
                    if (next == null)
                        break;
                    if (next.tagName.toLowerCase() === "input") {
                        next.focus();
                        next.select();
                        break;
                    }
                }
            } else if (length === 0) {
                var previous = target;
                while (previous = previous.previousElementSibling) {
                    if (previous == null)
                        break;
                    if (previous.tagName.toLowerCase() === "input") {
                        previous.focus();
                        break;
                    }
                }
            }
        }

        function checkProtocol(select) {
            var inputField = document.getElementById('udp_input_port');
            var inputField_2 = document.getElementById('in_xbee_group');
            var selectedValue = select.value;

            if (selectedValue !== '3') {
                inputField.setAttribute('disabled', 'disabled');
            } else {
                inputField.removeAttribute('disabled');
            }

            if (selectedValue !== '2') {
                inputField_2.setAttribute('disabled', 'disabled');
            } else {
                inputField_2.removeAttribute('disabled');
            }
        }

        function checkDaktronicsProtocol(select) {
            var in_dak_bcast = document.getElementById('in_dak_bcast');
            var in_dak_channel = document.getElementById('in_dak_channel');
            var in_daktro_id = document.getElementById('in_daktro_id');
            var selectedValue_dak = select.value;

            if (selectedValue_dak == '3') {
                in_dak_bcast.removeAttribute('disabled');
                in_dak_channel.removeAttribute('disabled');
                in_daktro_id.removeAttribute('disabled');
            } else {
                in_dak_bcast.setAttribute('disabled', 'disabled');
                in_dak_channel.setAttribute('disabled', 'disabled');
                in_daktro_id.setAttribute('disabled', 'disabled');
            }
        }

    </script>
</head>

<body class="bg-light">
    <div class="container">
        <div class="pt-5 text-center">
            <!-- <h2>ESP32 XBee Config <a id="project-version" href="https://github.com/nebkat/esp32-xbee/releases" class="text-muted small"></a> <a id="prerelease-available" class="text-info small" style="display: none">(beta available)</a></h2> -->

            <!-- <p class="lead">Adjust the settings below and then click on "Submit". The device will restart with the new settings applied. If you have adjusted WiFi settings the device may be moved onto a new IP address, or require you to reconnect to its access point.</p> -->
        </div>
        <form class="needs-validation" id="form" novalidate>
            <div class="row mb-1">
                <div class="col-xl-6">
                    <div class="card mb-3">
                        <div class="card-header">
                            WiFi
                            <small class="wifi-sta-status"></small>
                            <div class="custom-control custom-switch d-inline float-right">
                                <input type="checkbox" name="w_sta_active" value="1" checked
                                    class="custom-control-input" id="switch-wifi-sta">
                                <label class="custom-control-label" for="switch-wifi-sta"></label>
                            </div>
                            <div class="d-inline mr-1 float-right">
                                <input type="color" name="w_sta_color" data-disable-if="#switch-wifi-sta"
                                    value="#ffffff" id="color-wifi-sta">
                            </div>
                        </div>
                        <div class="card-body" data-disable-if="#switch-wifi-sta">
                            <div class="form-row mb-3">
                                <div class="col-8">
                                    <label>SSID</label>
                                    <div class="input-group">
                                        <input type="text" name="w_sta_ssid" class="wifi-networks-ssid form-control"
                                            maxlength="32" required>
                                        <div class="input-group-append">
                                            <button type="button"
                                                class="wifi-networks-dropdown btn btn-outline-secondary dropdown-toggle dropdown-toggle-split"
                                                data-toggle="dropdown" disabled></button>
                                            <div class="wifi-networks dropdown-menu">
                                                <h6 class="dropdown-header">Open networks</h6>
                                                <span class="wifi-networks-open">
                                                </span>
                                                <h6 class="dropdown-header">Secured networks</h6>
                                                <span class="wifi-networks-secured">
                                                </span>
                                            </div>
                                        </div>
                                        <div class="input-group-append">
                                            <button type="button"
                                                class="wifi-networks-scan btn btn-outline-secondary">Scan</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col">
                                    <label>Password</label>
                                    <input type="hidden" name="w_sta_pass" class="wifi-networks-pass-empty" value=""
                                        disabled>
                                    <div class="input-group">
                                        <input type="password" name="w_sta_pass"
                                            class="wifi-networks-pass form-control">
                                    </div>
                                </div>
                            </div>
                            <div class="form-row mb-3">
                                <div class="col-4">
                                    <label class="d-block">Scan mode <small class="text-muted" data-toggle="tooltip"
                                            title="In fast scan mode, WiFi channels are scanned sequentially and a connection is made to the first matching SSID.<br><br>In full (all channel) mode, every channel is scanned and if multiple matching SSIDs are found, the one with the strongest signal is chosen, but the process can be significantly slower.<br><br>This is useful in environments where there are a number of APs with the same SSID covering a large area. If you only have a single AP, fast mode is preferred.">?</small></label>
                                    <div class="btn-group btn-group-toggle d-flex" data-toggle="buttons">
                                        <label class="btn btn-outline-secondary">
                                            <input type="radio" name="w_sta_scan_mode" value="0" checked> Fast
                                        </label>
                                        <label class="btn btn-outline-secondary">
                                            <input type="radio" name="w_sta_scan_mode" value="1"> Full
                                        </label>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <label class="d-block">Hotspot forward <small class="text-muted"
                                            data-toggle="tooltip"
                                            title="If enabled, internet traffic from the WiFi hotspot is forwarded the main WiFi connection. Be aware that any device that connects to the hotspot will then have access to both networks, so a password for the hotspot is strongly recommended.">?</small></label>
                                    <div class="btn-group btn-group-toggle d-flex" data-toggle="buttons">
                                        <label class="btn btn-outline-warning">
                                            <input type="checkbox" value="1" name="w_sta_ap_fwd"> Forward
                                        </label>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <label class="d-block">IP config <small class="text-muted" data-toggle="tooltip"
                                            title="In DHCP mode, IPs will automatically be configured by the network upon successful connection.<br><br>In static mode, the IPs are hardcoded and must be set up correctly for the given WiFi network, but the connection is faster.">?</small></label>
                                    <div class="btn-group btn-group-toggle d-flex" data-toggle="buttons">
                                        <label class="btn btn-outline-success">
                                            <input type="radio" name="w_sta_static" value="0" checked> DHCP
                                        </label>
                                        <label class="btn btn-outline-warning">
                                            <input type="radio" name="w_sta_static" value="1"> Static
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div data-disable-if="input[type='radio'][name='w_sta_static']"
                                data-disable-if-condition="[value=0]:checked" class="form-row mb-3">
                                <div class="col">
                                    <label>IP address</label>
                                    <div class="input-group">
                                        <input type="number" name="w_sta_ip" value="10" maxlength="3" min="0" max="255"
                                            required class="form-control text-center px-1">
                                        <div class="input-group-append input-group-prepend">
                                            <span class="input-group-text px-1">.</span>
                                        </div>
                                        <input type="number" name="w_sta_ip" value="0" maxlength="3" min="0" max="255"
                                            required class="form-control text-center px-1">
                                        <div class="input-group-append input-group-prepend">
                                            <span class="input-group-text px-1">.</span>
                                        </div>
                                        <input type="number" name="w_sta_ip" value="0" maxlength="3" min="0" max="255"
                                            required class="form-control text-center px-1">
                                        <div class="input-group-append input-group-prepend">
                                            <span class="input-group-text px-1">.</span>
                                        </div>
                                        <input type="number" name="w_sta_ip" value="100" maxlength="3" min="0" max="255"
                                            required class="form-control text-center px-1">
                                    </div>
                                </div>
                                <div class="col-7">
                                    <label>Gateway and subnet</label>
                                    <div class="input-group">
                                        <input type="number" name="w_sta_gw" value="10" maxlength="3" min="0" max="255"
                                            required class="form-control text-center px-1">
                                        <div class="input-group-append input-group-prepend">
                                            <span class="input-group-text px-1">.</span>
                                        </div>
                                        <input type="number" name="w_sta_gw" value="0" maxlength="3" min="0" max="255"
                                            required class="form-control text-center px-1">
                                        <div class="input-group-append input-group-prepend">
                                            <span class="input-group-text px-1">.</span>
                                        </div>
                                        <input type="number" name="w_sta_gw" value="0" maxlength="3" min="0" max="255"
                                            required class="form-control text-center px-1">
                                        <div class="input-group-append input-group-prepend">
                                            <span class="input-group-text px-1">.</span>
                                        </div>
                                        <input type="number" name="w_sta_gw" value="1" maxlength="3" min="0" max="255"
                                            required class="form-control text-center px-1">
                                        <div class="input-group-append input-group-prepend">
                                            <span class="input-group-text px-1">/</span>
                                        </div>
                                        <select name="w_sta_subnet" class="custom-select px-2" required>
                                            <option value="8">8</option>
                                            <option value="9">9</option>
                                            <option value="10">10</option>
                                            <option value="11">11</option>
                                            <option value="12">12</option>
                                            <option value="13">13</option>
                                            <option value="14">14</option>
                                            <option value="15">15</option>
                                            <option value="16">16</option>
                                            <option value="17">17</option>
                                            <option value="18">18</option>
                                            <option value="19">19</option>
                                            <option value="20">20</option>
                                            <option value="21">21</option>
                                            <option value="22">22</option>
                                            <option value="23">23</option>
                                            <option value="24" selected>24</option>
                                            <option value="25">25</option>
                                            <option value="26">26</option>
                                            <option value="27">27</option>
                                            <option value="28">28</option>
                                            <option value="29">29</option>
                                            <option value="30">30</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div data-disable-if="input[type='radio'][name='w_sta_static']"
                                data-disable-if-condition="[value=0]:checked" class="form-row mb-3">
                                <div class="col">
                                    <label>DNS</label>
                                    <div class="input-group">
                                        <input type="number" name="w_sta_dns_a" value="1" maxlength="3" min="0"
                                            max="255" required class="form-control text-center px-1">
                                        <div class="input-group-append input-group-prepend">
                                            <span class="input-group-text px-1">.</span>
                                        </div>
                                        <input type="number" name="w_sta_dns_a" value="1" maxlength="3" min="0"
                                            max="255" required class="form-control text-center px-1">
                                        <div class="input-group-append input-group-prepend">
                                            <span class="input-group-text px-1">.</span>
                                        </div>
                                        <input type="number" name="w_sta_dns_a" value="1" maxlength="3" min="0"
                                            max="255" required class="form-control text-center px-1">
                                        <div class="input-group-append input-group-prepend">
                                            <span class="input-group-text px-1">.</span>
                                        </div>
                                        <input type="number" name="w_sta_dns_a" value="1" maxlength="3" min="0"
                                            max="255" required class="form-control text-center px-1">
                                    </div>
                                </div>
                                <div class="col">
                                    <label>Backup DNS</label>
                                    <div class="input-group">
                                        <input type="number" name="w_sta_dns_b" value="1" maxlength="3" min="0"
                                            max="255" required class="form-control text-center px-1">
                                        <div class="input-group-append input-group-prepend">
                                            <span class="input-group-text px-1">.</span>
                                        </div>
                                        <input type="number" name="w_sta_dns_b" value="0" maxlength="3" min="0"
                                            max="255" required class="form-control text-center px-1">
                                        <div class="input-group-append input-group-prepend">
                                            <span class="input-group-text px-1">.</span>
                                        </div>
                                        <input type="number" name="w_sta_dns_b" value="0" maxlength="3" min="0"
                                            max="255" required class="form-control text-center px-1">
                                        <div class="input-group-append input-group-prepend">
                                            <span class="input-group-text px-1">.</span>
                                        </div>
                                        <input type="number" name="w_sta_dns_b" value="1" maxlength="3" min="0"
                                            max="255" required class="form-control text-center px-1">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card mb-3">
                        <div class="card-header">
                            Admin (this page)
                        </div>
                        <div class="card-body">
                            <div class="form-row mb-3">
                                <div class="col-4">
                                    <label>Auth method</label>
                                    <select name="adm_auth" class="custom-select">
                                        <!-- <option value="0" selected>Open</option>
                                        <option value="1">Hotspot devices only</option> -->
                                        <option value="2">Username/password</option>
                                        <!--<option value="3">Button press</option>-->
                                    </select>
                                </div>
                                <div class="col-4">
                                    <label>Username</label>
                                    <input type="text" name="adm_user"
                                        data-disable-if="select[name='adm_auth'] > option[value!='2']"
                                        data-disable-if-condition=":selected" class="form-control" maxlength="32"
                                        required />
                                </div>
                                <div class="col-4">
                                    <label>Password</label>
                                    <input type="password" name="adm_pass"
                                        data-disable-if="select[name='adm_auth'] > option[value!='2']"
                                        data-disable-if-condition=":selected" class="form-control" maxlength="64"
                                        required />
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--
                    <div class="card mb-3">
                        <div class="card-header">
                            Bluetooth
                            <div class="custom-control custom-switch d-inline float-right">
                                <input type="checkbox" name="bt_active" value="1" class="custom-control-input" id="switch-bluetooth">
                                <label class="custom-control-label" for="switch-wifi-bluetooth"></label>
                            </div>
                        </div>
                        <div class="card-body" data-disable-if="#switch-bluetooth">
                            <div class="form-row mb-3">
                                <div class="col-8">
                                    <label>Device name</label>
                                    <div class="input-group">
                                        <input type="text" name="bt_dev_name" class="form-control" maxlength="32" required>
                                        <div class="input-group-append btn-group-toggle" data-toggle="buttons">
                                            <label class="btn btn-outline-secondary active">
                                                <input type="checkbox" name="bt_dev_vis" value="1" checked> Discoverable
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col">
                                    <label>Pin code</label>
                                    <div class="input-group">
                                        <input type="number" name="bt_pin_code" class="form-control text-center" maxlength="1" min="0" max="9" pattern="[0-9]" oninput="autoTab(this)" required/>
                                        <input type="number" name="bt_pin_code" class="form-control text-center" maxlength="1" min="0" max="9" pattern="[0-9]" oninput="autoTab(this)" required/>
                                        <input type="number" name="bt_pin_code" class="form-control text-center" maxlength="1" min="0" max="9" pattern="[0-9]" oninput="autoTab(this)" required/>
                                        <input type="number" name="bt_pin_code" class="form-control text-center" maxlength="1" min="0" max="9" pattern="[0-9]" oninput="autoTab(this)" required/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    -->
                </div>
                <div class="col-xl-6">
                    <div class="card mb-3">
                        <div class="card-header">
                            WiFi hotspot
                            <small class="wifi-ap-status"></small>
                            <div class="custom-control custom-switch d-inline float-right active">
                                <input type="checkbox" name="w_ap_active" value="1" checked class="custom-control-input"
                                    id="switch-wifi-ap">
                                <label class="custom-control-label" for="switch-wifi-ap"></label>
                            </div>
                            <div class="d-inline mr-1 float-right">
                                <input type="color" name="w_ap_color" data-disable-if="#switch-wifi-ap" value="#ffffff"
                                    id="color-wifi-ap">
                            </div>
                        </div>
                        <div class="card-body" data-disable-if="#switch-wifi-ap">
                            <div class="form-row mb-3">
                                <div class="col-6">
                                    <label>SSID</label>
                                    <div class="input-group">
                                        <input type="text" name="w_ap_ssid" class="form-control" maxlength="32">
                                        <div class="input-group-append btn-group-toggle" data-toggle="buttons">
                                            <label class="btn btn-outline-warning">
                                                <input type="checkbox" name="w_ap_ssid_hid" value="1"> Hidden
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <label>Security</label>
                                    <div class="input-group">
                                        <input type="password" name="w_ap_pass"
                                            data-disable-if="select[name='w_ap_auth_mode'] > option[value='0']"
                                            data-disable-if-condition=":selected" class="form-control"
                                            style="flex-grow: 2">
                                        <select name="w_ap_auth_mode" class="custom-select">
                                            <option value="0" selected>Open</option>
                                            <option value="1">WEP</option>
                                            <option value="2">WPA-PSK</option>
                                            <option value="3">WPA2-PSK</option>
                                            <option value="4">WPA/2-PSK (recommended)</option>
                                            <option value="4">WPA2 Enterprise</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="form-row mb-3">
                                <div class="col-6">
                                    <label>Gateway and subnet</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text px-1">192.168.</span>
                                        </div>
                                        <input type="hidden" name="w_ap_gw" value="192">
                                        <input type="hidden" name="w_ap_gw" value="168">
                                        <input type="number" name="w_ap_gw" value="4" maxlength="3" min="0" max="255"
                                            required class="form-control text-center px-1">
                                        <div class="input-group-append input-group-prepend">
                                            <span class="input-group-text px-1">.</span>
                                        </div>
                                        <input type="number" name="w_ap_gw" value="1" maxlength="3" min="1" max="254"
                                            required class="form-control text-center px-1">
                                        <div class="input-group-append input-group-prepend">
                                            <span class="input-group-text px-1">/</span>
                                        </div>
                                        <select name="w_ap_subnet" class="custom-select px-2" required>
                                            <option value="24" selected>24</option>
                                            <option value="25">25</option>
                                            <option value="26">26</option>
                                            <option value="27">27</option>
                                            <option value="28">28</option>
                                            <option value="29">29</option>
                                            <option value="30">30</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col">
                                    <label>Min/max IP address</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="wifi-ap-ip-prefix input-group-text">192.168.4.</span>
                                        </div>
                                        <input type="number" name="w_ap_ip_min" value="1" disabled
                                            class="form-control text-center px-1">
                                        <div class="input-group-append input-group-prepend">
                                            <span class="input-group-text">-</span>
                                        </div>
                                        <input type="number" name="w_ap_ip_max" value="254" disabled
                                            class="form-control text-center px-1">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card mb-3 border border-warning">
                        <div class="card-header">
                            Set Config Protocol
                            <small class="uart-stats stream-stats" data-stream="uart"></small>
                        </div>
                        <div class="card-body">
                            <div class="form-row mb-3">
                                <div class="col-8">
                                    <label style="color:green"><b>Input</b></label>
                                    <div class="protocol-name-list">
                                        <label for="protocol">Bluetooth, Wireless, Serial or CAN bus:</label>
                                        <select name="in_pro_type" id="switch-wire-wireless" class="custom-select"
                                            onchange="checkProtocol(this)">
                                            <option value="1" selected>Bluetooth</option>
                                            <option value="2">Wifi-UDP</option>
                                            <option value="3">Wifi-TCP</option>
                                            <option value="4">Serial Port</option>
                                            <option value="5">CAN Bus</option>
                                            <option value="6">UART usb Port dev kit</option>
                                        </select>
                                    </div>
                                    <h6>
                                        <span>
                                            <label style="color:green"><b>TCP IP</b></label>
                                            <input type="text" name="in_tcp_ip" id="input-tcp-ip"
                                                class="wifi-networks-ssid form-control">

                                                
                                            <label href="javascript:void(0)" style="color:green" id="input-tcp-portt"
                                                for="protocol"><b>TCP Port:</b></label>
                                            <div>
                                                <input type="number" name="in_tcp_port" id="in_tcp_port" value="8023"
                                                    maxlength="5" min="0" max="65535" class="form-control" required>
                                            </div>

                                            <label href="javascript:void(0)" style="color:green" id="input-udp-port"
                                                for="protocol"><b>UDP Port:</b></label>
                                            <div>
                                                <input type="number" name="in_udp_port" id="in_udp_port" value="8023"
                                                    maxlength="5" min="0" max="65535" class="form-control" required>
                                            </div>

                                            <div class="protocol-name-list">
                                                <label for="protocol">Serial input/output baudrate:</label>
                                                <select name="serial_baurate" id="serial-baudrate"
                                                    class="custom-select">
                                                    <option value="110" selected>110</option>
                                                    <option value="300">300</option>
                                                    <option value="600">600</option>
                                                    <option value="1200">1200</option>
                                                    <option value="2400">2400</option>
                                                    <option value="4800">4800</option>
                                                    <option value="9600">9600</option>
                                                    <option value="14400">14400</option>
                                                    <option value="19200">19200</option>
                                                    <option value="38400">38400</option>
                                                    <option value="57600">57600</option>
                                                    <option value="115200">115200</option>
                                                    <option value="128000">128000</option>
                                                    <option value="256000">256000</option>
                                                </select>
                                            </div>
                                    </h6>
                                </div>
                            </div>
                            <div class="form-row mb-3">
                                <div class="col-8">
                                    <label style="color:green"><b>Output</b></label>
                                    <div class="protocol-name-list">
                                        <label for="protocol">Bluetooth, Wireless, Serial or CAN bus:</label>
                                        <select name="out_pro_type" id="switch-wire-wireless" class="custom-select">
                                            <option value="1" selected>Bluetooth</option>
                                            <option value="2">Wifi-UDP</option>
                                            <option value="3">Wifi-TCP</option>
                                            <option value="4">Serial Port</option>
                                            <option value="5">CAN Bus</option>
                                            <option value="6">UART usb Port dev kit</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="form-row mb-3">
                                <div class="col-md-4 col-6">
                                    <!-- <label>Baud rate</label>
                                    <div class="input-group">
                                        <select name="uart_baud_rate" id="uart-baud-rate" class="custom-select" required>
                                            <option value="9600">9600</option>
                                            <option value="19200">19200</option>
                                            <option value="38400">38400</option>
                                            <option value="57600"selected>57600</option>
                                            <option value="115200">115200</option>
                                            <option value="230400">230400</option>
                                            <option value="460800">460800</option>
                                            <option value="921600">921600</option>
                                        </select>
                                        <div class="input-group-append">
                                            <span class="input-group-text px-2">baud</span>
                                        </div>
                                    </div> -->
                                </div>
                                <div class="col-md col-6">
                                    <!-- <label>Data bits</label>
                                    <div class="input-group">
                                        <select name="uart_data_bits" class="custom-select" required>
                                            <option value="0">5</option>
                                            <option value="1">6</option>
                                            <option value="2">7</option>
                                            <option value="3" selected>8</option>
                                        </select>
                                        <div class="input-group-append">
                                            <span class="input-group-text px-2">bits</span>
                                        </div>
                                    </div> -->
                                </div>
                                <div class="col-md col-6">
                                    <!-- <label>Stop bits</label>
                                    <div class="input-group">
                                        <select name="uart_stop_bits" class="custom-select" required>
                                            <option value="1" selected>1</option>
                                            <option value="2">1.5</option>
                                            <option value="3">2</option>
                                        </select>
                                        <div class="input-group-append">
                                            <span class="input-group-text px-2">bits</span>
                                        </div>
                                    </div> -->
                                </div>
                                <div class="col-md col-6">
                                    <!-- <label>Parity</label>
                                    <select name="uart_parity" class="custom-select px-2" required>
                                        <option value="0" selected>Disabled</option>
                                        <option value="2">Even</option>
                                        <option value="3">Odd</option>
                                    </select> -->
                                </div>
                            </div>
                            <!-- <div class="form-row">
                                <div class="col-3">
                                    <label class="d-block">Log forward  <small class="text-muted" data-toggle="tooltip" title="If enabled, log messages (normally sent to UART1, and visible on the /log.html page) are forwarded to the main UART, primarily for debugging purposes. This setting can interfere with normal communication over UART0.">?</small></label>
                                    <div class="btn-group btn-group-toggle d-flex" data-toggle="buttons">
                                        <label class="btn btn-outline-warning">
                                            <input type="checkbox" value="1" name="uart_log_fwd"> Print
                                        </label>
                                    </div>
                                </div>
                                <div class="col-5">
                                    <label class="d-block">Flow control</label>
                                    <div class="btn-group btn-group-toggle d-flex" data-toggle="buttons">
                                        <label class="btn btn-outline-success">
                                            <input type="checkbox" value="1" name="uart_fc_rts"> RTS
                                        </label>
                                        <label class="btn btn-outline-primary">
                                            <input type="checkbox" value="1" name="uart_fc_cts"> CTS
                                        </label>
                                    </div>
                                </div>
                                <div class="col">
                                    <label>RTS pin</label>
                                    <input type="number" name="uart_rts_pin" data-disable-if="input[type='checkbox'][name='uart_fc_rts']" class="form-control" placeholder="22" value="22" required>
                                </div>
                                <div class="col">
                                    <label>CTS pin</label>
                                    <input type="number" name="uart_cts_pin" data-disable-if="input[type='checkbox'][name='uart_fc_cts']" class="form-control" placeholder="19" value="19" required>
                                </div>
                            </div> -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col">
                    <input type="submit" class="form-control">
                </div>
            </div>
    </div>
    </form>
    </div>
    <!-- <footer id="footer" class="bg-dark">
        <div class="container">
            <div class="text-center text-light">
                <small><a></a> ESP32 Bridge</a> - Uptime <span class="uptime">loading...</span> - Heap <span
                        class="heap">loading...</span></small>
            </div>
        </div>
    </footer> -->
    <div class="modal fade" id="restarting-modal">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Waiting for restart...</h4>
                </div>
                <div class="modal-body">
                    <p>The ESP32 XBee has been restarted to apply the new configuration.</p>
                    <p>Please wait a few seconds, and this page will automatically reload.</p>
                    <p>If you have made changes to the WiFi connection, or are using the ESP32's WiFi hotspot, you may
                        need to check your device's WiFi connection, or read the new IP address from a serial terminal.
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" onclick="window.location.reload()">Reload</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Get the radio buttons and the text field
        var radioButtons = form.querySelectorAll('.setup_protocol input[type="radio"]');
        var textfield = form.getElementById('sck_cli_host');
        const twentyRadioButton = form.getElementById('twenty');
        const thirtyRadioButton = form.getElementById('thirty');
        console.log("testing");
        radioButtons.forEach(radioButton => {
            radioButton.addEventListener('click', function () {
                if (radioButton === twentyRadioButton) {
                    textfield.value = 20;
                } else if (radioButton === thirtyRadioButton) {
                    textfield.value = 30;
                }
            });
        });
    </script>
</body>

</html>